apiVersion: stackgres.io/v1
kind: SGScript
metadata:
  name: fsdevops-db-init
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
  labels:
    app.kubernetes.io/part-of: fsdevops-portfolio
    app.kubernetes.io/component: database
spec:
  scripts:
    - name: create-database-and-user
      script: |
        DO $$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'fsdevops') THEN
            CREATE USER fsdevops WITH PASSWORD '<DB_PASSWORD>';
          END IF;
        END
        $$;
        SELECT 'CREATE DATABASE fsdevops' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'fsdevops')\gexec
        GRANT ALL PRIVILEGES ON DATABASE fsdevops TO fsdevops;
    - name: grant-schema-privileges
      database: fsdevops
      script: |
        GRANT ALL ON SCHEMA public TO fsdevops;
---
apiVersion: stackgres.io/v1
kind: SGCluster
metadata:
  name: fsdevops-db
  labels:
    app.kubernetes.io/part-of: fsdevops-portfolio
    app.kubernetes.io/component: database
spec:
  instances: 1
  postgres:
    version: "16.4"
  sgInstanceProfile: fsdevops-db-profile
  configurations:
    sgPostgresConfig: fsdevops-db-pgconfig
  managedSql:
    scripts:
      - sgScript: fsdevops-db-init
  pods:
    persistentVolume:
      size: 5Gi
      storageClass: longhorn
  nonProductionOptions:
    disableClusterPodAntiAffinity: true
